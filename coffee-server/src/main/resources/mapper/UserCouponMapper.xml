<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coffee.mapper.UserCouponMapper">

    <!-- 根据用户ID和状态查询用户优惠券列表 -->
    <select id="selectByUserIdAndStatus" resultType="com.coffee.vo.UserCouponVO">
        SELECT
            uc.id,
            uc.user_id AS userId,
            uc.coupon_id AS couponId,
            c.name AS couponName,
            c.type AS couponType,
            c.discount_amount AS discountAmount,
            c.discount_rate AS discountRate,
            c.min_amount AS minAmount,
            uc.status,
            uc.get_time AS getTime,
            uc.use_time AS useTime,
            c.start_time AS startTime,
            c.end_time AS endTime,
            uc.order_id AS orderId
        FROM user_coupons uc
        LEFT JOIN coupons c ON uc.coupon_id = c.id
        WHERE uc.user_id = #{userId}
        <if test="status != null">
            AND uc.status = #{status}
        </if>
        ORDER BY uc.get_time DESC
    </select>

    <!-- 根据用户ID查询所有用户优惠券 -->
    <select id="selectByUserId" resultType="com.coffee.vo.UserCouponVO">
        SELECT
            uc.id,
            uc.user_id AS userId,
            uc.coupon_id AS couponId,
            c.name AS couponName,
            c.type AS couponType,
            c.discount_amount AS discountAmount,
            c.discount_rate AS discountRate,
            c.min_amount AS minAmount,
            uc.status,
            uc.get_time AS getTime,
            uc.use_time AS useTime,
            c.start_time AS startTime,
            c.end_time AS endTime,
            uc.order_id AS orderId
        FROM user_coupons uc
        LEFT JOIN coupons c ON uc.coupon_id = c.id
        WHERE uc.user_id = #{userId}
        ORDER BY uc.get_time DESC
    </select>

    <!-- 插入用户优惠券 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO user_coupons (
            user_id, coupon_id, status, get_time
        ) VALUES (
                     #{userId}, #{couponId}, #{status}, #{getTime}
                 )
    </insert>

    <!-- 根据ID查询用户优惠券 -->
    <select id="selectById" resultType="com.coffee.vo.UserCouponVO">
        SELECT
            uc.id,
            uc.user_id AS userId,
            uc.coupon_id AS couponId,
            c.name AS couponName,
            c.type AS couponType,
            c.discount_amount AS discountAmount,
            c.discount_rate AS discountRate,
            c.min_amount AS minAmount,
            uc.status,
            uc.get_time AS getTime,
            uc.use_time AS useTime,
            c.start_time AS startTime,
            c.end_time AS endTime,
            uc.order_id AS orderId
        FROM user_coupons uc
        LEFT JOIN coupons c ON uc.coupon_id = c.id
        WHERE uc.id = #{id}
    </select>

    <!-- 更新用户优惠券状态 -->
    <update id="updateStatus">
        UPDATE user_coupons
        SET status = #{status},
            use_time = NOW(),
            order_id = #{orderId}
        WHERE id = #{id}
    </update>

    <!-- 检查用户是否已领取该优惠券 -->
    <select id="countByUserIdAndCouponId" resultType="int">
        SELECT COUNT(*)
        FROM user_coupons
        WHERE user_id = #{userId} AND coupon_id = #{couponId}
    </select>

</mapper>